<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="https://unpkg.com/vue@next"></script>
</head>
<body>
    <hr />
    <div id="main">
        <div id="Custom_list" v-if="UI === 'Custom_main'">
            <h1>This is the main page.</h1>
            <button @click="Custom_loadList()">購物車</button>
            <table border="1">
                <tr>
                    <td>序號</td>
                    <td>商品名稱</td>
                    <td>價格</td>
                    <td>-</td>
                    <td>內容</td>
                </tr>
                <tr v-for="Custom_job in dat">
                    <td>{{ Custom_job.c_id }}</td>
                    <td>{{ Custom_job.c_jobName }}</td>
                    <td>{{ Custom_job.c_jobUrgent }}</td>
                    <td><button @click="Custom_addJobToCart(Custom_job)">加入購物車</button></td>
                    <td>{{ Custom_job.c_jobDescription }}</td>
                </tr>
            </table>
        </div>
        <div v-if="UI === 'Custom_editForm'">
            商品名稱: <td>{{ Custom_newJob.c_jobName }}</td> <br/>
            價格: <td>{{ Custom_newJob.c_jobUrgent }}</td> <br/>
            購買數量: <textarea v-model="Custom_newJob.purchaseAmount"></textarea><br>
            內容: <td>{{ Custom_newJob.c_jobDescription }}</td></textarea><br>
            <input type='button' @click="Custom_addJob()" value="save">
        </div>
        <div id="list" v-if="UI === 'cart'">
            <h1>This is the cart page.</h1>
            <button @click="Custom_loadList()">商品清單</button>
            <table border="1">
                <tr>
                    <td>序號</td>
                    <td>商品名稱</td>
                    <td>價格</td>
                    <td>購買數量</td>
                    <td>-</td>
                    <td>內容</td>
                </tr>
                <tr v-for="Custom_job in c_dat">
                    <td>{{ Custom_job.c_id }}</td>
                    <td>{{ Custom_job.c_jobName }}</td>
                    <td>{{ Custom_job.c_jobUrgent }}</td>
                    <td>{{ Custom_job.c_purchaseAmount }}</td>
                    <td><button @click="Custom_delJob(Custom_job.c_id)">從購物車移除</button></td>
                    <td>{{ Custom_job.c_jobDescription }}</td>
                </tr>
            </table>
            <td>總價:</td><td>{{ total }}</td>
            <button @click="Custom_createOrder()">送出訂單</button>
        </div>
    </div>
    <script>
        const todoApp = Vue.createApp({
            data() {
                return {
                    UI: 'Custom_main',
                    c_dat: [],
                    dat: [],
                    Custom_newJob: {
                        c_id: -1,
                        c_jobName: '',
                        c_jobUrgent: '',
                        c_jobContent: '',
                        c_jobDescription: '',
                        purchaseAmount: 0
                    },
                    total: 0
                };
            },
            methods: {
                Custom_loadList: function () {
                    const that = this;
                    fetch('productControl.php?act=listPurchaseJob')
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(myJson) {
                            that.dat = myJson;
                            that.total = 0;
                            for (let i = 0; i < that.dat.length; i++) {
                                that.total += that.dat[i].total_price;
                            }
                            that.setUI('cart');
                        });
                },
                Custom_createOrder: function () {
                    const that = this;
                    let mydat = new FormData();
                    mydat.append("cartItems", JSON.stringify(this.dat));
                    let url = "productControl.php?act=createOrder";
                    fetch(url, {
                        method: 'POST',
                        body: mydat
                    })
                    .then(function(res) {
                        return res.text();
                    })
                    .then(function(data) {
                        console.log(data);
                        that.Custom_loadList();
                    });
                },
                Custom_delJob: function (Custom_id) {
                    const that = this;
                    let url = "productControl.php?act=delCart&id=" + Custom_id;
                    fetch(url, {
                        method: 'POST'
                    })
                    .then(function(res) {
                        return res.text();
                    })
                    .then(function(data) {
                        console.log(data);
                        that.Custom_loadList();
                    });
                },
                Custom_addJobToCart: function (Custom_job) {
                    this.Custom_newJob = Custom_job;
                    this.setUI('Custom_editForm');
                },
                Custom_addJob: function () {
                    const that = this;
                    let mydat = new FormData();
                    mydat.append("dat", JSON.stringify(this.Custom_newJob));
                    let url = "productControl.php?act=addCart";
                    fetch(url, {
                        method: 'POST',
                        body: mydat
                    })
                    .then(function(res) {
                        return res.text();
                    })
                    .then(function(data) {
                        console.log(data);
                        that.setUI('cart');
                        that.Custom_loadList();
                    });
                },
                setUI: function(page) {
                    this.UI = page;
                }
            },
            created() {
                this.Custom_loadList();
            }
        }).mount("#main");
    </script>
</body>
</html>
